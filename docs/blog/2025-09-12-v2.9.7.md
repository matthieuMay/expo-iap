---
slug: v2.9.7
title: v2.9.7 — Unified connection guards, Android subs note
tags: [release, android, ios]
---

Release highlights:

- Android: remove `ensureConnection` wrapper, rely on BillingClient auto‑reconnect, and add a clear pre‑check that also verifies `isReady`.
- Android: drop deprecated product fields in mappings (use `nameAndroid`, `oneTimePurchaseOfferDetailsAndroid`, `subscriptionOfferDetailsAndroid`).
- iOS: add `ensureConnection()` guard across public APIs; fix main‑actor state mutation and minor warnings.

<!-- truncate -->

import AdFitTopFixed from "@site/src/uis/AdFitTopFixed";

<AdFitTopFixed />

Heads‑up for Android subscriptions (offer tokens)

When purchasing subscriptions on Android with `type: 'subs'`, pass the selected offer tokens via `subscriptionOffers` so native can build `BillingFlowParams` correctly. A common error if omitted:

> The number of skus (1) must match: the number of offerTokens (0) for Subscriptions

Example flow:

```ts
import {
  fetchProducts,
  requestPurchase,
  type SubscriptionProduct,
} from 'expo-iap';

// 1) Fetch your subscription product(s)
const products = await fetchProducts({skus: ['premium_monthly'], type: 'subs'});
const sub = products.find(
  (p) => p.id === 'premium_monthly',
) as SubscriptionProduct;

// 2) Build subscriptionOffers from the fetched product details
const subscriptionOffers = (sub.subscriptionOfferDetailsAndroid ?? []).map(
  (offer) => ({
    sku: sub.id,
    offerToken: offer.offerToken,
  }),
);

// 3) Request purchase
await requestPurchase({
  request: {
    ios: {
      sku: sub.id,
      andDangerouslyFinishTransactionAutomatically: false,
    },
    android: {
      skus: [sub.id],
      subscriptionOffers,
    },
  },
  type: 'subs',
});
```

Notes:

- Pick the offer that matches your desired base plan/intro pricing. If you only sell one base plan, you can pass just that single offer token.
- `fetchProducts` returns Android specifics under `subscriptionOfferDetailsAndroid` and `oneTimePurchaseOfferDetailsAndroid`.

Changelog

See `CHANGELOG.md` for the full list of changes in 2.9.7.
