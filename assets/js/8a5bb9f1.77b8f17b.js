"use strict";(globalThis.webpackChunkexpo_iap_docs=globalThis.webpackChunkexpo_iap_docs||[]).push([[5359],{571:(e,n,r)=>{r.d(n,{A:()=>t});var s=r(6540),i=r(4848);function o({className:e="adfit",style:n,unit:r,height:o,width:t}){return(0,s.useEffect)(()=>{const n=setTimeout(()=>{const n=document.querySelector(`.${e}`);if(!n)return void console.warn(`AdFit: Element with class "${e}" not found`);const s=n.querySelectorAll(".kakao_ad_area"),i=n.querySelectorAll('script[src*="kas/static/ba.min.js"]');s.forEach(e=>e.remove()),i.forEach(e=>e.remove());const c=document.createElement("ins"),a=document.createElement("script");c.className="kakao_ad_area",c.style.cssText="display:none; width:100%;",a.async=!0,a.type="text/javascript",a.src="//t1.daumcdn.net/kas/static/ba.min.js",c.setAttribute("data-ad-width",t.toString()),c.setAttribute("data-ad-height",o.toString()),c.setAttribute("data-ad-unit",r),n.appendChild(c),n.appendChild(a)},100);return()=>clearTimeout(n)},[e,r,o,t]),(0,i.jsx)("div",{style:n,children:(0,i.jsx)("div",{className:e})})}function t(){return(0,i.jsx)(o,{unit:"DAN-YTmjDwlbcP42HBg6",height:100,width:320,className:"adfit-top",style:{flex:1,marginTop:24,marginBottom:24}})}},8453:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>c});var s=r(6540);const i={},o=s.createContext(i);function t(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),s.createElement(o.Provider,{value:n},e.children)}},8829:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>f,contentTitle:()=>a,default:()=>u,frontMatter:()=>c,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"guides/subscription-offers","title":"Subscription Offers","description":"This guide explains how to handle subscription offers (pricing plans) when purchasing subscriptions on iOS and Android platforms.","source":"@site/docs/guides/subscription-offers.md","sourceDirName":"guides","slug":"/guides/subscription-offers","permalink":"/expo-iap/docs/guides/subscription-offers","draft":false,"unlisted":false,"editUrl":"https://github.com/hyochan/expo-iap/tree/main/docs/docs/guides/subscription-offers.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Subscription Offers","sidebar_label":"Subscription Offers","sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Lifecycle","permalink":"/expo-iap/docs/guides/lifecycle"},"next":{"title":"Subscription Validation","permalink":"/expo-iap/docs/guides/subscription-validation"}}');var i=r(4848),o=r(8453),t=r(571);const c={title:"Subscription Offers",sidebar_label:"Subscription Offers",sidebar_position:3},a="Subscription Offers",f={},d=[{value:"Overview",id:"overview",level:2},{value:"Platform Differences",id:"platform-differences",level:2},{value:"Android Subscription Offers",id:"android-subscription-offers",level:3},{value:"Required for Android Subscriptions",id:"required-for-android-subscriptions",level:4},{value:"Getting Offer Tokens",id:"getting-offer-tokens",level:4},{value:"Purchase with Offers",id:"purchase-with-offers",level:4},{value:"Understanding Offer Details",id:"understanding-offer-details",level:4},{value:"iOS Subscription Offers",id:"ios-subscription-offers",level:3},{value:"Base Plan (Default)",id:"base-plan-default",level:4},{value:"Introductory Offers",id:"introductory-offers",level:4},{value:"Promotional Offers (Optional)",id:"promotional-offers-optional",level:4},{value:"Getting Available Promotional Offers",id:"getting-available-promotional-offers",level:5},{value:"Applying Promotional Offers",id:"applying-promotional-offers",level:5},{value:"Common Patterns",id:"common-patterns",level:2},{value:"Selecting Specific Offers",id:"selecting-specific-offers",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Android Errors",id:"android-errors",level:3},{value:"iOS Errors",id:"ios-errors",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"See Also",id:"see-also",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"subscription-offers",children:"Subscription Offers"})}),"\n",(0,i.jsx)(t.A,{}),"\n",(0,i.jsx)(n.p,{children:"This guide explains how to handle subscription offers (pricing plans) when purchasing subscriptions on iOS and Android platforms."}),"\n",(0,i.jsxs)(n.p,{children:["For a complete implementation example, see the ",(0,i.jsx)(n.a,{href:"/expo-iap/docs/examples/subscription-flow",children:"Subscription Flow Example"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"Subscription offers represent different pricing plans for the same subscription product:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Base Plan"}),": The standard pricing for a subscription"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Introductory Offers"}),": Special pricing for new subscribers (free trial, discounted period)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Promotional Offers"}),": Limited-time discounts configured in the app stores"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"platform-differences",children:"Platform Differences"}),"\n",(0,i.jsx)(n.p,{children:"At a glance:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Android: subscription offers are required when purchasing subscriptions. You must pass ",(0,i.jsx)(n.code,{children:"subscriptionOffers"})," with one or more offer tokens from ",(0,i.jsx)(n.code,{children:"fetchProducts()"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["iOS: base plan is used by default. Promotional discounts are optional via ",(0,i.jsx)(n.code,{children:"withOffer"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Tip: Always fetch products first; offers only exist after ",(0,i.jsx)(n.code,{children:"fetchProducts({ type: 'subs' })"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"android-subscription-offers",children:"Android Subscription Offers"}),"\n",(0,i.jsxs)(n.p,{children:["Android requires explicit specification of subscription offers when purchasing. Each offer is identified by an ",(0,i.jsx)(n.code,{children:"offerToken"})," obtained from ",(0,i.jsx)(n.code,{children:"fetchProducts()"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"required-for-android-subscriptions",children:"Required for Android Subscriptions"}),"\n",(0,i.jsxs)(n.p,{children:["Unlike iOS, Android subscriptions ",(0,i.jsx)(n.strong,{children:"must"})," include ",(0,i.jsx)(n.code,{children:"subscriptionOffers"})," in the purchase request. Without it, the purchase will fail with:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-text",children:"The number of skus (1) must match: the number of offerTokens (0)\n"})}),"\n",(0,i.jsx)(n.h4,{id:"getting-offer-tokens",children:"Getting Offer Tokens"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"import {useIAP} from 'expo-iap';\n\nconst SubscriptionComponent = () => {\n  const {connected, subscriptions, fetchProducts, requestPurchase} = useIAP();\n\n  // 1) Fetch subscription products\n  useEffect(() => {\n    if (connected) {\n      fetchProducts({skus: ['premium_monthly'], type: 'subs'});\n    }\n  }, [connected]);\n\n  // 2) Access offer details from fetched subscriptions\n  const subscription = subscriptions.find((s) => s.id === 'premium_monthly');\n\n  if (subscription?.subscriptionOfferDetailsAndroid) {\n    console.log(\n      'Available offers:',\n      subscription.subscriptionOfferDetailsAndroid,\n    );\n    // Each offer contains: basePlanId, offerId?, offerTags, offerToken, pricingPhases\n  }\n};\n"})}),"\n",(0,i.jsx)(n.h4,{id:"purchase-with-offers",children:"Purchase with Offers"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"const purchaseSubscription = async (subscriptionId: string) => {\n  const subscription = subscriptions.find((s) => s.id === subscriptionId);\n  if (!subscription) return;\n\n  // Build subscriptionOffers from fetched data\n  const subscriptionOffers = (\n    subscription.subscriptionOfferDetailsAndroid ?? []\n  )\n    .map((offer) =>\n      offer?.offerToken\n        ? {\n            sku: subscriptionId,\n            offerToken: offer.offerToken,\n          }\n        : null,\n    )\n    .filter((offer): offer is {sku: string; offerToken: string} =>\n      Boolean(offer?.offerToken),\n    );\n\n  // Only proceed if offers are available\n  if (subscriptionOffers.length === 0) {\n    console.error('No subscription offers available');\n    return;\n  }\n\n  await requestPurchase({\n    request: {\n      ios: {sku: subscriptionId},\n      android: {\n        skus: [subscriptionId],\n        subscriptionOffers:\n          subscriptionOffers.length > 0 ? subscriptionOffers : undefined,\n      },\n    },\n    type: 'subs',\n  });\n};\n"})}),"\n",(0,i.jsx)(n.h4,{id:"understanding-offer-details",children:"Understanding Offer Details"}),"\n",(0,i.jsxs)(n.p,{children:["Each ",(0,i.jsx)(n.code,{children:"subscriptionOfferDetailsAndroid"})," item contains:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"interface ProductSubscriptionAndroidOfferDetails {\n  basePlanId: string; // Base plan identifier\n  offerId?: string | null; // Offer identifier (null for base plan)\n  offerTags: string[]; // Tags associated with the offer\n  offerToken: string; // Token required for purchase\n  pricingPhases: PricingPhasesAndroid; // Pricing information\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"ios-subscription-offers",children:"iOS Subscription Offers"}),"\n",(0,i.jsx)(n.p,{children:"iOS handles subscription offers differently - the base plan is used by default, and promotional offers are optional."}),"\n",(0,i.jsx)(n.h4,{id:"base-plan-default",children:"Base Plan (Default)"}),"\n",(0,i.jsx)(n.p,{children:"For standard subscription purchases, no special offer specification is needed:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"await requestPurchase({\n  request: {\n    ios: {sku: 'premium_monthly'},\n    android: {\n      skus: [\n        'premium_monthly',\n      ] /* include subscriptionOffers only if available */,\n    },\n  },\n  type: 'subs',\n});\n"})}),"\n",(0,i.jsx)(n.h4,{id:"introductory-offers",children:"Introductory Offers"}),"\n",(0,i.jsx)(n.p,{children:"iOS automatically applies introductory prices (free trials, intro pricing) configured in App Store Connect. No additional code is needed - users will see the introductory offer when eligible."}),"\n",(0,i.jsx)(n.p,{children:"To check if a subscription has an introductory offer:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"const subscription = subscriptions.find((s) => s.id === 'premium_monthly');\n\nif (subscription?.subscriptionInfoIOS?.introductoryOffer) {\n  const offer = subscription.subscriptionInfoIOS.introductoryOffer;\n\n  switch (offer.paymentMode) {\n    case 'free-trial':\n      console.log(\n        `${offer.periodCount} ${offer.period.unit.toLowerCase()}(s) free trial`,\n      );\n      break;\n    case 'pay-as-you-go':\n      console.log(\n        `${offer.displayPrice} for ${\n          offer.periodCount\n        } ${offer.period.unit.toLowerCase()}(s)`,\n      );\n      break;\n    case 'pay-up-front':\n      console.log(\n        `${offer.displayPrice} for first ${\n          offer.periodCount\n        } ${offer.period.unit.toLowerCase()}(s)`,\n      );\n      break;\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h4,{id:"promotional-offers-optional",children:"Promotional Offers (Optional)"}),"\n",(0,i.jsxs)(n.p,{children:["iOS supports promotional offers through the ",(0,i.jsx)(n.code,{children:"withOffer"})," parameter. These are server-to-server offers that require signature generation from your backend."]}),"\n",(0,i.jsx)(n.h5,{id:"getting-available-promotional-offers",children:"Getting Available Promotional Offers"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"const subscription = subscriptions.find((s) => s.id === 'premium_monthly');\n\nif (subscription?.discountsIOS) {\n  console.log('Available promotional offers:');\n  subscription.discountsIOS.forEach((discount) => {\n    console.log('- Identifier:', discount.identifier);\n    console.log('  Price:', discount.localizedPrice);\n    console.log('  Payment mode:', discount.paymentMode);\n    console.log('  Subscription period:', discount.subscriptionPeriod);\n    console.log('  Number of periods:', discount.numberOfPeriods);\n  });\n}\n"})}),"\n",(0,i.jsx)(n.h5,{id:"applying-promotional-offers",children:"Applying Promotional Offers"}),"\n",(0,i.jsxs)(n.p,{children:["To apply a promotional offer, you need to generate a signature on your backend server. See ",(0,i.jsx)(n.a,{href:"https://developer.apple.com/documentation/storekit/in-app_purchase/original_api_for_in-app_purchase/subscriptions_and_offers/generating_a_signature_for_promotional_offers",children:"Apple's documentation"})," for signature generation."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"interface DiscountOfferInputIOS {\n  identifier: string; // Offer identifier from discountsIOS\n  keyIdentifier: string; // Your App Store Connect key ID\n  nonce: string; // UUID generated on device\n  signature: string; // Generated by your backend\n  timestamp: number; // Unix timestamp in milliseconds\n}\n\nconst purchaseWithPromotionalOffer = async (\n  subscriptionId: string,\n  offerId: string,\n) => {\n  // 1. Generate signature on your backend\n  const nonce = generateUUID(); // Use a UUID library\n  const timestamp = Date.now();\n\n  const signature = await fetch('https://your-backend.com/generate-signature', {\n    method: 'POST',\n    body: JSON.stringify({\n      productId: subscriptionId,\n      offerId: offerId,\n      applicationUsername: 'user-123', // Optional\n      nonce: nonce,\n      timestamp: timestamp,\n    }),\n  }).then((res) => res.json());\n\n  // 2. Purchase with the promotional offer\n  await requestPurchase({\n    request: {\n      ios: {\n        sku: subscriptionId,\n        withOffer: {\n          identifier: offerId,\n          keyIdentifier: signature.keyIdentifier,\n          nonce: nonce,\n          signature: signature.signature,\n          timestamp: timestamp,\n        },\n      },\n      android: {skus: [subscriptionId], subscriptionOffers: [...]},\n    },\n    type: 'subs',\n  });\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"common-patterns",children:"Common Patterns"}),"\n",(0,i.jsx)(n.h3,{id:"selecting-specific-offers",children:"Selecting Specific Offers"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"const selectOffer = (\n  subscription: ProductSubscription,\n  offerType: 'base' | 'introductory',\n) => {\n  if (Platform.OS === 'ios') {\n    // iOS: Check for introductory offer\n    if (offerType === 'introductory') {\n      return subscription.subscriptionInfoIOS?.introductoryOffer ?? null;\n    }\n    // Base plan is default, no selection needed\n    return null;\n  }\n\n  // Android: Select offer based on type\n  const offers = subscription.subscriptionOfferDetailsAndroid ?? [];\n\n  if (offerType === 'base') {\n    // Find base plan (no offerId)\n    return offers.find((offer) => !offer.offerId);\n  } else {\n    // Find introductory offer\n    return offers.find((offer) => offer.offerId?.includes('introductory'));\n  }\n};\n\nconst purchaseWithSelectedOffer = async (\n  subscriptionId: string,\n  offerType: 'base' | 'introductory' = 'base',\n) => {\n  const subscription = subscriptions.find((s) => s.id === subscriptionId);\n  if (!subscription) return;\n\n  const selectedOffer = selectOffer(subscription, offerType);\n\n  if (Platform.OS === 'android') {\n    const subscriptionOffers = selectedOffer\n      ? [\n          {\n            sku: subscriptionId,\n            offerToken: selectedOffer.offerToken,\n          },\n        ]\n      : [];\n\n    if (subscriptionOffers.length === 0) {\n      console.error('No suitable offer found');\n      return;\n    }\n\n    await requestPurchase({\n      request: {\n        ios: {sku: subscriptionId},\n        android: {\n          skus: [subscriptionId],\n          subscriptionOffers:\n            subscriptionOffers.length > 0 ? subscriptionOffers : undefined,\n        },\n      },\n      type: 'subs',\n    });\n  } else {\n    // iOS: Introductory offers are automatically applied\n    // selectedOffer contains intro price info for display purposes\n    if (offerType === 'introductory' && selectedOffer) {\n      console.log('Offer:', selectedOffer.displayPrice);\n      console.log('Payment mode:', selectedOffer.paymentMode);\n    }\n\n    await requestPurchase({\n      request: {\n        ios: {sku: subscriptionId},\n        android: {\n          skus: [\n            subscriptionId,\n          ] /* include subscriptionOffers only if available */,\n        },\n      },\n      type: 'subs',\n    });\n  }\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsx)(n.h3,{id:"android-errors",children:"Android Errors"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"import {useIAP, ErrorCode} from 'expo-iap';\n\nconst {requestPurchase} = useIAP({\n  onPurchaseError: (error) => {\n    if (error.code === ErrorCode.PurchaseError) {\n      console.error('Purchase failed - check subscription offers');\n      // Ensure subscriptionOffers is included and valid\n    }\n  },\n});\n"})}),"\n",(0,i.jsx)(n.h3,{id:"ios-errors",children:"iOS Errors"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-tsx",children:"import {useIAP, ErrorCode} from 'expo-iap';\n\nconst {requestPurchase} = useIAP({\n  onPurchaseError: (error) => {\n    if (error.code === ErrorCode.Unknown) {\n      console.error('Invalid promotional offer for iOS');\n      // Check offerIdentifier, signature, etc.\n    }\n  },\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Always fetch products first"}),": Subscription offers are only available after ",(0,i.jsx)(n.code,{children:"fetchProducts()"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Handle platform differences"}),": Android requires offers, iOS makes them optional."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Validate offers"}),": Check that offers exist before attempting purchase."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"User selection"}),": Allow users to choose between different pricing plans when multiple offers are available."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Error recovery"}),": Provide fallback to base plan if selected offer fails."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../api/use-iap",children:"useIAP Hook"})," - Main API documentation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../examples/subscription-flow",children:"Subscription Flow Example"})," - Complete implementation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../api/error-codes",children:"Error Codes"})," - Purchase error handling"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}}}]);